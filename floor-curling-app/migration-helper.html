<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase è¿ç§»è„šæœ¬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }

        h1 {
            color: #00d4ff;
        }

        .instructions {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .step {
            margin: 15px 0;
            padding: 10px;
            background: #0f3460;
            border-radius: 5px;
        }

        .step-number {
            background: #00d4ff;
            color: #000;
            padding: 2px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 10px;
        }

        textarea {
            width: 100%;
            height: 400px;
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .copy-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #2ea043;
        }

        .link {
            color: #58a6ff;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <h1>ğŸ¯ åœ°å£ºçƒå¹³å° - æ•°æ®åº“è¿ç§»</h1>

    <div class="instructions">
        <h2>ğŸ“‹ æ“ä½œæ­¥éª¤</h2>

        <div class="step">
            <span class="step-number">1</span>
            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶ SQL è„šæœ¬
        </div>

        <div class="step">
            <span class="step-number">2</span>
            æ‰“å¼€ <a class="link" href="https://app.supabase.com/project/sonpzrmonpvsrpcjvzsb/sql/new"
                target="_blank">Supabase SQL Editor â†—</a>
        </div>

        <div class="step">
            <span class="step-number">3</span>
            åœ¨ SQL Editor ä¸­ç‚¹å‡» "New Query"ï¼Œç²˜è´´è„šæœ¬ï¼Œç„¶åç‚¹å‡» "Run"
        </div>

        <div class="step">
            <span class="step-number">4</span>
            åˆ›å»º Storage å­˜å‚¨æ¡¶ï¼šè¿›å…¥ <a class="link"
                href="https://app.supabase.com/project/sonpzrmonpvsrpcjvzsb/storage/buckets" target="_blank">Storage
                â†—</a>ï¼Œåˆ›å»ºåä¸º "evidence" çš„å…¬å…±å­˜å‚¨æ¡¶
        </div>
    </div>

    <h2>ğŸ“ SQL è¿ç§»è„šæœ¬</h2>
    <button class="copy-btn" onclick="copySQL()">ğŸ“‹ å¤åˆ¶ SQL è„šæœ¬åˆ°å‰ªè´´æ¿</button>

    <textarea id="sqlScript" readonly>
-- =====================================================
-- åœ°å£ºçƒ (Floor Curling) å¹³å°æ•°æ®åº“è¿ç§»è„šæœ¬
-- Supabase PostgreSQL Schema
-- =====================================================

-- å¯ç”¨å¿…è¦çš„æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- 1. åˆ›å»ºæšä¸¾ç±»å‹
-- =====================================================

-- ç”¨æˆ·è§’è‰²æšä¸¾
CREATE TYPE user_role AS ENUM ('admin', 'pharmacist', 'family', 'elder');

-- æ¯”èµ›é˜Ÿä¼é¢œè‰²æšä¸¾
CREATE TYPE team_color AS ENUM ('red', 'yellow');

-- =====================================================
-- 2. åˆ›å»ºæ ¸å¿ƒè¡¨
-- =====================================================

-- ç”¨æˆ·æ¡£æ¡ˆè¡¨ (æ‰©å±• auth.users)
CREATE TABLE public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    role user_role NOT NULL DEFAULT 'elder',
    store_id TEXT,
    linked_family_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- é’±åŒ…è¡¨ (åŒè´¦æˆ·ç³»ç»Ÿ)
CREATE TABLE public.wallets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL UNIQUE REFERENCES public.profiles(id) ON DELETE CASCADE,
    global_points BIGINT NOT NULL DEFAULT 0 CHECK (global_points >= 0),
    local_points BIGINT NOT NULL DEFAULT 0 CHECK (local_points >= 0),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- è£…å¤‡è¡¨ (RPG é£æ ¼è£…å¤‡)
CREATE TABLE public.equipment (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL UNIQUE,
    description TEXT,
    stats JSONB NOT NULL DEFAULT '{}',
    rarity TEXT,
    image_url TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- èƒŒåŒ…/åº“å­˜è¡¨
CREATE TABLE public.inventory (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    equipment_id UUID NOT NULL REFERENCES public.equipment(id) ON DELETE CASCADE,
    quantity INT NOT NULL DEFAULT 1 CHECK (quantity > 0),
    is_equipped BOOLEAN NOT NULL DEFAULT FALSE,
    acquired_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT unique_user_equipment UNIQUE (user_id, equipment_id)
);

-- æ¯”èµ›è¡¨
CREATE TABLE public.matches (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    store_id TEXT NOT NULL,
    red_team_elder_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE RESTRICT,
    yellow_team_elder_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE RESTRICT,
    winner_color team_color,
    status TEXT NOT NULL DEFAULT 'in_progress',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    CONSTRAINT different_elders CHECK (red_team_elder_id != yellow_team_elder_id)
);

-- æ¯”èµ›å›åˆè¡¨
CREATE TABLE public.match_ends (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    match_id UUID NOT NULL REFERENCES public.matches(id) ON DELETE CASCADE,
    end_number INT NOT NULL CHECK (end_number >= 1 AND end_number <= 6),
    red_score INT NOT NULL DEFAULT 0 CHECK (red_score >= 0),
    yellow_score INT NOT NULL DEFAULT 0 CHECK (yellow_score >= 0),
    house_snapshot_url TEXT,
    vibe_video_url TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT unique_match_end UNIQUE (match_id, end_number)
);

-- äº¤æ˜“è®°å½•è¡¨ (ç”¨äºè§¦å‘é€šçŸ¥)
CREATE TABLE public.transactions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    transaction_type TEXT NOT NULL,
    amount BIGINT NOT NULL DEFAULT 0,
    balance_after BIGINT NOT NULL DEFAULT 0,
    description TEXT,
    match_id UUID REFERENCES public.matches(id),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- é€šçŸ¥è¡¨
CREATE TABLE public.notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    recipient_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    notification_type TEXT NOT NULL DEFAULT 'LINE',
    title TEXT NOT NULL,
    message TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending',
    sent_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =====================================================
-- 3. å¯ç”¨ RLS
-- =====================================================

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.wallets ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.equipment ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.inventory ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.matches ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.match_ends ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

-- =====================================================
-- 4. åˆ›å»ºåŸºæœ¬ RLS ç­–ç•¥ (å…è®¸æœåŠ¡è®¿é—®)
-- =====================================================

-- å…è®¸æ‰€æœ‰è®¤è¯ç”¨æˆ·æŸ¥çœ‹æ•°æ® (ç®€åŒ–ç‰ˆæœ¬ï¼Œç”Ÿäº§ç¯å¢ƒåº”æ›´ä¸¥æ ¼)
CREATE POLICY "Enable read access for authenticated users" ON public.profiles FOR SELECT TO authenticated USING (true);
CREATE POLICY "Enable read access for authenticated users" ON public.wallets FOR SELECT TO authenticated USING (true);
CREATE POLICY "Enable read access for all" ON public.equipment FOR SELECT USING (true);
CREATE POLICY "Enable read access for authenticated users" ON public.inventory FOR SELECT TO authenticated USING (true);
CREATE POLICY "Enable read access for authenticated users" ON public.matches FOR SELECT TO authenticated USING (true);
CREATE POLICY "Enable read access for authenticated users" ON public.match_ends FOR SELECT TO authenticated USING (true);
CREATE POLICY "Enable read access for authenticated users" ON public.transactions FOR SELECT TO authenticated USING (true);
CREATE POLICY "Enable read access for authenticated users" ON public.notifications FOR SELECT TO authenticated USING (true);

-- å…è®¸æ’å…¥
CREATE POLICY "Enable insert for authenticated users" ON public.profiles FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Enable insert for authenticated users" ON public.wallets FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Enable insert for authenticated users" ON public.matches FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Enable insert for authenticated users" ON public.match_ends FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Enable insert for authenticated users" ON public.transactions FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Enable insert for authenticated users" ON public.notifications FOR INSERT TO authenticated WITH CHECK (true);

-- å…è®¸æ›´æ–°
CREATE POLICY "Enable update for authenticated users" ON public.profiles FOR UPDATE TO authenticated USING (true);
CREATE POLICY "Enable update for authenticated users" ON public.wallets FOR UPDATE TO authenticated USING (true);
CREATE POLICY "Enable update for authenticated users" ON public.matches FOR UPDATE TO authenticated USING (true);
CREATE POLICY "Enable update for authenticated users" ON public.notifications FOR UPDATE TO authenticated USING (true);

-- =====================================================
-- 5. æ’å…¥ç¤ºä¾‹è£…å¤‡
-- =====================================================

INSERT INTO public.equipment (name, description, stats, rarity) VALUES
    ('Speed Base', 'æå‡æ»‘è¡Œé€Ÿåº¦çš„åŸºåº§', '{"speed": 15, "control": 5}', 'common'),
    ('Blocker Base', 'å¢å¼ºé˜²å®ˆèƒ½åŠ›çš„åŸºåº§', '{"defense": 20, "stability": 10}', 'rare'),
    ('Precision Pusher', 'æå‡ç²¾å‡†åº¦çš„æ¨æ†', '{"accuracy": 25, "control": 15}', 'epic'),
    ('Power Grip', 'å¢åŠ æ¨åŠ›çš„æ¡æŠŠ', '{"power": 30, "speed": 10}', 'legendary');

-- =====================================================
-- è¿ç§»å®Œæˆï¼
-- =====================================================
    </textarea>

    <script>
        function copySQL() {
            const textarea = document.getElementById('sqlScript');
            textarea.select();
            document.execCommand('copy');
            alert('âœ… SQL è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nè¯·å‰å¾€ Supabase SQL Editor ç²˜è´´å¹¶æ‰§è¡Œã€‚');
        }
    </script>
</body>

</html>